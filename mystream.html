<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="referrer" content="strict-origin-when-cross-origin">
<title>MyStream â€” ë‚˜ë§Œì˜ ë°©ì†¡êµ­</title>
<link href="https://fonts.googleapis.com/css2?family=Black+Han+Sans&family=Noto+Sans+KR:wght@300;400;500;700&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/hls.js/1.4.12/hls.min.js"></script>
<style>
:root {
  --bg: #0a0a0f;
  --surface: #13131a;
  --surface2: #1c1c28;
  --surface3: #22223a;
  --border: #2a2a3d;
  --accent: #e63946;
  --accent2: #ff6b6b;
  --text: #eeeef5;
  --text2: #9999bb;
  --live: #22c55e;
  --youtube: #ff0000;
  --m3u: #3b82f6;
  --custom: #a855f7;
  --fav: #f59e0b;
  --sidebar-w: 280px;
}
* { margin:0; padding:0; box-sizing:border-box; }
body { background:var(--bg); color:var(--text); font-family:'Noto Sans KR',sans-serif; min-height:100vh; overflow-x:hidden; }

/* HEADER */
header {
  position:fixed; top:0; left:0; right:0; z-index:200;
  display:flex; align-items:center; justify-content:space-between;
  padding:0 24px; height:60px;
  background:rgba(10,10,15,0.97);
  border-bottom:1px solid var(--border);
  backdrop-filter:blur(16px);
}
.logo { font-family:'Black Han Sans',sans-serif; font-size:20px; letter-spacing:2px; color:var(--accent); text-shadow:0 0 24px rgba(230,57,70,0.4); }
.logo span { color:var(--text); }
.header-center { display:flex; align-items:center; gap:8px; }
.header-actions { display:flex; gap:8px; align-items:center; }
.live-badge { display:flex; align-items:center; gap:5px; font-size:11px; color:var(--live); }
.live-dot { width:7px; height:7px; border-radius:50%; background:var(--live); animation:pulse 2s infinite; }
@keyframes pulse { 0%,100%{opacity:1} 50%{opacity:0.4} }
@keyframes spin { to{transform:rotate(360deg)} }
@keyframes fadeIn { from{opacity:0;transform:translateY(8px)} to{opacity:1;transform:translateY(0)} }

/* BUTTONS */
.btn { padding:7px 16px; border-radius:6px; border:none; cursor:pointer; font-family:'Noto Sans KR',sans-serif; font-size:12px; font-weight:500; transition:all 0.2s; }
.btn-primary { background:var(--accent); color:white; }
.btn-primary:hover { background:var(--accent2); transform:translateY(-1px); }
.btn-ghost { background:transparent; color:var(--text2); border:1px solid var(--border); }
.btn-ghost:hover { border-color:var(--accent); color:var(--accent); }
.btn-sm { padding:5px 10px; font-size:11px; }

/* LAYOUT */
.app { display:grid; grid-template-columns:var(--sidebar-w) 1fr; grid-template-rows:60px 1fr; height:100vh; }
.sidebar { grid-row:1/3; background:var(--surface); border-right:1px solid var(--border); overflow-y:auto; padding-top:60px; display:flex; flex-direction:column; }
.main { grid-column:2; grid-row:2; overflow-y:auto; }

/* SIDEBAR */
.sidebar-tabs { display:flex; border-bottom:1px solid var(--border); flex-shrink:0; }
.sidebar-tab { flex:1; padding:10px 4px; text-align:center; font-size:11px; font-weight:600; color:var(--text2); cursor:pointer; border-bottom:2px solid transparent; transition:all 0.15s; letter-spacing:0.5px; }
.sidebar-tab.active { color:var(--accent); border-bottom-color:var(--accent); }
.sidebar-panel { display:none; flex-direction:column; flex:1; overflow-y:auto; }
.sidebar-panel.active { display:flex; }

/* ì¹´í…Œê³ ë¦¬ í•„í„° */
.cat-filter { display:flex; gap:6px; padding:10px 12px; overflow-x:auto; flex-shrink:0; border-bottom:1px solid var(--border); }
.cat-filter::-webkit-scrollbar { height:0; }
.cat-chip { padding:4px 10px; border-radius:20px; font-size:11px; border:1px solid var(--border); color:var(--text2); background:transparent; cursor:pointer; white-space:nowrap; transition:all 0.15s; }
.cat-chip.active { background:rgba(230,57,70,0.15); border-color:var(--accent); color:var(--accent); }

/* CHANNEL ITEMS */
.ch-list { padding:8px; flex:1; }
.channel-item { display:flex; align-items:center; gap:9px; padding:9px 10px; border-radius:8px; cursor:pointer; transition:all 0.15s; position:relative; margin-bottom:2px; }
.channel-item:hover { background:var(--surface2); }
.channel-item.active { background:rgba(230,57,70,0.1); }
.channel-item.active::before { content:''; position:absolute; left:0; top:4px; bottom:4px; width:3px; border-radius:0 3px 3px 0; background:var(--accent); }
.ch-icon { width:34px; height:34px; border-radius:8px; display:flex; align-items:center; justify-content:center; font-size:15px; flex-shrink:0; }
.ch-icon.youtube { background:rgba(255,0,0,0.12); color:var(--youtube); }
.ch-icon.m3u { background:rgba(59,130,246,0.12); color:var(--m3u); }
.ch-icon.custom { background:rgba(168,85,247,0.12); color:var(--custom); }
.ch-info { flex:1; min-width:0; }
.ch-name { font-size:12px; font-weight:500; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
.ch-meta { font-size:10px; color:var(--text2); margin-top:1px; display:flex; align-items:center; gap:4px; }
.ch-actions { display:none; gap:2px; flex-shrink:0; }
.channel-item:hover .ch-actions { display:flex; }
.ch-btn { background:none; border:none; color:var(--text2); font-size:13px; cursor:pointer; padding:3px 5px; border-radius:4px; transition:all 0.15s; line-height:1; }
.ch-btn:hover { color:var(--accent); background:rgba(230,57,70,0.12); }
.ch-btn.fav-on { color:var(--fav); }
.fav-dot { width:6px; height:6px; border-radius:50%; background:var(--fav); flex-shrink:0; }

/* PLAYER */
.player-section { padding:20px; }
.player-wrapper { position:relative; width:100%; aspect-ratio:16/9; background:#000; border-radius:12px; overflow:hidden; box-shadow:0 20px 60px rgba(0,0,0,0.8); }
.player-wrapper iframe, .player-wrapper video { width:100%; height:100%; border:none; display:block; }
.player-placeholder { display:flex; flex-direction:column; align-items:center; justify-content:center; height:100%; color:var(--text2); gap:12px; }
.player-placeholder .icon { font-size:56px; opacity:0.25; }

/* ë©€í‹°ë·° */
.multiview-wrapper { display:none; width:100%; aspect-ratio:16/9; background:#000; border-radius:12px; overflow:hidden; box-shadow:0 20px 60px rgba(0,0,0,0.8); }
.multiview-wrapper.active { display:grid; }
.mv-2 { grid-template-columns:1fr 1fr; }
.mv-4 { grid-template-columns:1fr 1fr; grid-template-rows:1fr 1fr; }
.mv-cell { position:relative; background:#0a0a0f; border:1px solid var(--border); overflow:hidden; cursor:pointer; }
.mv-cell.selected { border-color:var(--accent); }
.mv-cell iframe, .mv-cell video { width:100%; height:100%; border:none; display:block; }
.mv-cell-label { position:absolute; bottom:0; left:0; right:0; padding:4px 8px; background:rgba(0,0,0,0.7); font-size:10px; color:white; display:flex; justify-content:space-between; align-items:center; }
.mv-cell-empty { display:flex; align-items:center; justify-content:center; height:100%; color:var(--text2); font-size:12px; flex-direction:column; gap:8px; }

/* í”Œë ˆì´ì–´ ì»¨íŠ¸ë¡¤ ë°” */
.player-controls { display:flex; align-items:center; justify-content:space-between; padding:10px 0 0; }
.player-info-left { min-width:0; }
.player-title { font-size:17px; font-weight:700; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
.player-meta { font-size:12px; color:var(--text2); margin-top:2px; }
.player-actions { display:flex; gap:6px; align-items:center; flex-shrink:0; }
.type-badge { padding:3px 10px; border-radius:20px; font-size:10px; font-weight:700; letter-spacing:1px; text-transform:uppercase; }
.type-badge.youtube { background:rgba(255,0,0,0.15); color:var(--youtube); border:1px solid rgba(255,0,0,0.25); }
.type-badge.m3u { background:rgba(59,130,246,0.15); color:var(--m3u); border:1px solid rgba(59,130,246,0.25); }
.type-badge.custom { background:rgba(168,85,247,0.15); color:var(--custom); border:1px solid rgba(168,85,247,0.25); }

/* ë©€í‹°ë·° ì»¨íŠ¸ë¡¤ */
.mv-controls { display:flex; gap:6px; align-items:center; }
.mv-btn { padding:5px 10px; border-radius:6px; border:1px solid var(--border); background:transparent; color:var(--text2); font-size:11px; cursor:pointer; transition:all 0.15s; }
.mv-btn.active { background:rgba(230,57,70,0.15); border-color:var(--accent); color:var(--accent); }

/* CHANNEL GRID */
.section-header { display:flex; align-items:center; justify-content:space-between; padding:20px 20px 12px; }
.section-title { font-family:'Black Han Sans',sans-serif; font-size:16px; letter-spacing:1px; }
.channel-grid { display:grid; grid-template-columns:repeat(auto-fill,minmax(160px,1fr)); gap:12px; padding:0 20px 20px; }
.channel-card { background:var(--surface); border-radius:10px; overflow:hidden; cursor:pointer; transition:all 0.2s; border:1px solid var(--border); position:relative; }
.channel-card:hover { transform:translateY(-3px); border-color:var(--accent); box-shadow:0 8px 24px rgba(230,57,70,0.15); }
.channel-card.playing { border-color:var(--accent); box-shadow:0 0 0 2px rgba(230,57,70,0.25); }
.card-thumb { aspect-ratio:16/9; display:flex; align-items:center; justify-content:center; font-size:28px; position:relative; }
.card-thumb.youtube-bg { background:linear-gradient(135deg,#1a0000,#3d0000); }
.card-thumb.m3u-bg { background:linear-gradient(135deg,#001233,#001f6e); }
.card-thumb.custom-bg { background:linear-gradient(135deg,#1a0033,#3d006e); }
.card-live-badge { position:absolute; top:6px; left:6px; background:var(--live); color:white; font-size:8px; font-weight:700; padding:2px 5px; border-radius:3px; letter-spacing:1px; }
.card-fav { position:absolute; top:6px; right:6px; font-size:14px; }
.card-body { padding:10px; }
.card-name { font-size:12px; font-weight:600; margin-bottom:2px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
.card-sub { font-size:10px; color:var(--text2); display:flex; align-items:center; justify-content:space-between; }
.cat-tag { font-size:9px; padding:1px 6px; border-radius:10px; background:var(--surface2); border:1px solid var(--border); }

/* ìµœê·¼ ë³¸ ì±„ë„ */
.recent-strip { padding:0 20px 16px; }
.recent-title { font-size:11px; font-weight:700; color:var(--text2); letter-spacing:1.5px; text-transform:uppercase; margin-bottom:8px; }
.recent-list { display:flex; gap:8px; overflow-x:auto; padding-bottom:4px; }
.recent-list::-webkit-scrollbar { height:3px; }
.recent-list::-webkit-scrollbar-thumb { background:var(--border); border-radius:2px; }
.recent-chip { display:flex; align-items:center; gap:6px; padding:6px 10px; background:var(--surface); border:1px solid var(--border); border-radius:8px; cursor:pointer; white-space:nowrap; font-size:11px; transition:all 0.15s; flex-shrink:0; }
.recent-chip:hover { border-color:var(--accent); color:var(--accent); }

/* SEARCH */
.search-bar { display:flex; align-items:center; background:var(--surface2); border:1px solid var(--border); border-radius:8px; padding:0 12px; gap:8px; margin:0 20px 16px; }
.search-bar input { background:none; border:none; flex:1; padding:9px 0; color:var(--text); font-family:'Noto Sans KR',sans-serif; font-size:13px; outline:none; }
.search-icon { color:var(--text2); font-size:14px; }

/* EPG */
.epg-strip { margin:0 20px 16px; background:var(--surface); border-radius:8px; border:1px solid var(--border); padding:10px 14px; display:flex; align-items:center; gap:10px; overflow-x:auto; }
.epg-item { flex-shrink:0; padding:6px 12px; border-radius:6px; background:var(--surface2); text-align:center; min-width:100px; }
.epg-time { font-size:10px; color:var(--accent); font-weight:700; }
.epg-show { font-size:11px; margin-top:2px; }
.epg-item.now { background:rgba(230,57,70,0.12); border:1px solid rgba(230,57,70,0.25); }

/* MODAL */
.modal-overlay { display:none; position:fixed; inset:0; z-index:500; background:rgba(0,0,0,0.85); backdrop-filter:blur(6px); align-items:center; justify-content:center; }
.modal-overlay.open { display:flex; }
.modal { background:var(--surface); border-radius:16px; border:1px solid var(--border); padding:28px; width:500px; max-width:calc(100vw - 32px); max-height:90vh; overflow-y:auto; animation:fadeIn 0.2s ease; }
.modal-title { font-family:'Black Han Sans',sans-serif; font-size:18px; margin-bottom:20px; }
.form-group { margin-bottom:14px; }
label { display:block; font-size:11px; color:var(--text2); margin-bottom:5px; font-weight:600; letter-spacing:0.5px; text-transform:uppercase; }
input, select, textarea { width:100%; padding:9px 12px; background:var(--surface2); border:1px solid var(--border); border-radius:7px; color:var(--text); font-family:'Noto Sans KR',sans-serif; font-size:13px; outline:none; transition:border-color 0.15s; }
input:focus, select:focus { border-color:var(--accent); }
select option { background:var(--surface2); }
.modal-actions { display:flex; gap:8px; justify-content:flex-end; margin-top:20px; }

/* TYPE TABS */
.type-tabs { display:flex; gap:6px; margin-bottom:16px; }
.type-tab { padding:7px 14px; border-radius:7px; cursor:pointer; font-size:12px; border:1px solid var(--border); color:var(--text2); background:transparent; transition:all 0.15s; font-family:'Noto Sans KR',sans-serif; }
.type-tab.active.youtube { border-color:var(--youtube); color:var(--youtube); background:rgba(255,0,0,0.08); }
.type-tab.active.m3u { border-color:var(--m3u); color:var(--m3u); background:rgba(59,130,246,0.08); }
.type-tab.active.custom { border-color:var(--custom); color:var(--custom); background:rgba(168,85,247,0.08); }

/* M3U ë“œë˜ê·¸ ì˜ì—­ */
.drop-zone { border:2px dashed var(--border); border-radius:10px; padding:28px; text-align:center; color:var(--text2); cursor:pointer; transition:all 0.2s; margin-bottom:14px; }
.drop-zone:hover, .drop-zone.drag-over { border-color:var(--m3u); background:rgba(59,130,246,0.06); color:var(--m3u); }
.drop-zone .dz-icon { font-size:32px; margin-bottom:8px; }
.drop-zone p { font-size:13px; }
.drop-zone span { font-size:11px; opacity:0.7; }

/* SCROLLBAR */
::-webkit-scrollbar { width:4px; }
::-webkit-scrollbar-track { background:transparent; }
::-webkit-scrollbar-thumb { background:var(--border); border-radius:4px; }

/* íŒíŠ¸ ë°•ìŠ¤ */
.hint-box { margin:0 20px 16px; background:rgba(59,130,246,0.06); border:1px solid rgba(59,130,246,0.18); border-radius:8px; padding:12px 16px; font-size:12px; color:var(--text2); line-height:1.8; }
.hint-box strong { color:var(--m3u); }

/* ê³µê°œ ì†ŒìŠ¤ ì„¹ì…˜ */
.pub-section-label { font-size:10px; color:var(--text2); padding:10px 10px 6px; font-weight:700; letter-spacing:1.5px; text-transform:uppercase; }

/* ì§„í–‰ë¥  ë°” */
.m3u-progress { padding:12px; }
.progress-bar { height:4px; background:var(--surface2); border-radius:2px; overflow:hidden; }
.progress-fill { height:100%; background:var(--m3u); border-radius:2px; transition:width 0.3s; }

/* ì•Œë¦¼ í† ìŠ¤íŠ¸ */
.toast { position:fixed; bottom:24px; right:24px; z-index:9999; background:var(--surface2); border:1px solid var(--border); border-radius:10px; padding:12px 18px; font-size:13px; animation:fadeIn 0.2s ease; display:flex; align-items:center; gap:10px; max-width:320px; box-shadow:0 8px 32px rgba(0,0,0,0.4); }
.toast.success { border-color:rgba(34,197,94,0.4); }
.toast.error { border-color:rgba(230,57,70,0.4); }
</style>
</head>
<body>

<header>
  <div class="logo">MY<span>STREAM</span></div>
  <div class="header-center">
    <div class="live-badge"><div class="live-dot"></div>LIVE</div>
  </div>
  <div class="header-actions">
    <button class="btn btn-ghost" onclick="openModal('mv-modal')" title="ë©€í‹°ë·°">âŠ ë©€í‹°ë·°</button>
    <button class="btn btn-ghost" onclick="openModal('search-modal')">ğŸ” ì†ŒìŠ¤</button>
    <button class="btn btn-primary" onclick="openModal('add-modal')">ï¼‹ ì±„ë„ ì¶”ê°€</button>
  </div>
</header>

<div class="app">
  <!-- SIDEBAR -->
  <aside class="sidebar">
    <div class="sidebar-tabs">
      <div class="sidebar-tab active" onclick="switchSideTab('my')">ğŸ“¡ ë‚´ ì±„ë„</div>
      <div class="sidebar-tab" onclick="switchSideTab('fav')">â­ ì¦ê²¨ì°¾ê¸°</div>
      <div class="sidebar-tab" onclick="switchSideTab('pub')">ğŸŒ ê³µê°œ</div>
    </div>

    <!-- ë‚´ ì±„ë„ íŒ¨ë„ -->
    <div class="sidebar-panel active" id="panel-my">
      <div class="cat-filter" id="cat-filter">
        <div class="cat-chip active" data-cat="all" onclick="setCat('all',this)">ì „ì²´</div>
      </div>
      <div class="ch-list" id="sidebar-channels"></div>
    </div>

    <!-- ì¦ê²¨ì°¾ê¸° íŒ¨ë„ -->
    <div class="sidebar-panel" id="panel-fav">
      <div class="ch-list" id="sidebar-favs"></div>
    </div>

    <!-- ê³µê°œ ì†ŒìŠ¤ íŒ¨ë„ -->
    <div class="sidebar-panel" id="panel-pub">
      <div id="public-sources"></div>
    </div>
  </aside>

  <!-- MAIN -->
  <main class="main">
    <div class="player-section">
      <!-- ì‹±ê¸€ í”Œë ˆì´ì–´ -->
      <div class="player-wrapper" id="player-wrapper">
        <div class="player-placeholder" id="player-placeholder">
          <div class="icon">ğŸ“º</div>
          <p style="font-size:14px">ì±„ë„ì„ ì„ íƒí•˜ë©´ ì—¬ê¸°ì„œ ì¬ìƒë©ë‹ˆë‹¤</p>
        </div>
        <video id="hls-player" style="display:none" controls playsinline></video>
        <div id="yt-placeholder" style="display:none;width:100%;height:100%;position:relative"></div>
        <iframe id="custom-player" style="display:none" allowfullscreen allow="autoplay; encrypted-media"></iframe>
      </div>

      <!-- ë©€í‹°ë·° í”Œë ˆì´ì–´ -->
      <div class="multiview-wrapper" id="multiview-wrapper"></div>

      <!-- í”Œë ˆì´ì–´ ì»¨íŠ¸ë¡¤ -->
      <div class="player-controls" id="player-info" style="display:none">
        <div class="player-info-left">
          <div class="player-title" id="player-title">â€”</div>
          <div class="player-meta" id="player-meta">â€”</div>
        </div>
        <div class="player-actions">
          <button class="btn btn-ghost btn-sm" id="fav-toggle-btn" onclick="toggleFavCurrent()">â˜† ì¦ê²¨ì°¾ê¸°</button>
          <button class="btn btn-ghost btn-sm" onclick="addToMultiview()">âŠ ë©€í‹°ë·°ì— ì¶”ê°€</button>
          <div class="type-badge" id="player-badge">â€”</div>
        </div>
      </div>
    </div>

    <!-- EPG -->
    <div class="epg-strip" id="epg-strip" style="display:none"></div>

    <!-- ìµœê·¼ ë³¸ ì±„ë„ -->
    <div class="recent-strip" id="recent-strip" style="display:none">
      <div class="recent-title">ğŸ• ìµœê·¼ ë³¸ ì±„ë„</div>
      <div class="recent-list" id="recent-list"></div>
    </div>

    <!-- ê²€ìƒ‰ -->
    <div class="search-bar">
      <span class="search-icon">ğŸ”</span>
      <input type="text" id="channel-search" placeholder="ì±„ë„ ê²€ìƒ‰..." oninput="renderGrid()">
    </div>

    <!-- íŒíŠ¸ -->
    <div class="hint-box" id="hint-box">
      ğŸ’¡ <strong>ì‹œì‘í•˜ê¸°:</strong> ì™¼ìª½ <strong>ê³µê°œ</strong> íƒ­ì—ì„œ ë°”ë¡œ ì¬ìƒí•˜ê±°ë‚˜, <strong>+ ì±„ë„ ì¶”ê°€</strong>ë¡œ YouTube/M3U/ì»¤ìŠ¤í…€ URLì„ ì¶”ê°€í•˜ì„¸ìš”.<br>
      M3U í”Œë ˆì´ë¦¬ìŠ¤íŠ¸ íŒŒì¼ì„ ë¶ˆëŸ¬ì˜¤ë©´ ìˆ˜ë°± ê°œ ì±„ë„ì„ í•œë²ˆì— ì¶”ê°€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
    </div>

    <!-- ì±„ë„ ê·¸ë¦¬ë“œ -->
    <div class="section-header">
      <div class="section-title">ğŸ“¡ ë‚´ ë°©ì†¡êµ­</div>
      <div style="font-size:12px;color:var(--text2)" id="ch-count">0ê°œ ì±„ë„</div>
    </div>
    <div id="channel-grid" class="channel-grid"></div>
  </main>
</div>

<!-- ====== ì±„ë„ ì¶”ê°€ ëª¨ë‹¬ ====== -->
<div class="modal-overlay" id="add-modal">
  <div class="modal">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px">
      <div class="modal-title" style="margin-bottom:0">ì±„ë„ ì¶”ê°€</div>
      <button style="background:none;border:none;color:var(--text2);font-size:20px;cursor:pointer" onclick="closeModal('add-modal')">âœ•</button>
    </div>
    <div class="type-tabs">
      <button class="type-tab active youtube" data-type="youtube" onclick="setType('youtube',this)">â–¶ YouTube</button>
      <button class="type-tab m3u" data-type="m3u" onclick="setType('m3u',this)">ğŸ“¡ M3U/HLS</button>
      <button class="type-tab custom" data-type="custom" onclick="setType('custom',this)">ğŸ”— ì»¤ìŠ¤í…€</button>
      <button class="type-tab" data-type="m3u-file" onclick="setType('m3u-file',this)" style="border-color:var(--m3u)">ğŸ“‚ M3U íŒŒì¼</button>
    </div>

    <!-- M3U íŒŒì¼ ì—…ë¡œë“œ -->
    <div id="m3u-file-section" style="display:none">
      <div class="drop-zone" id="drop-zone" onclick="document.getElementById('m3u-file-input').click()">
        <div class="dz-icon">ğŸ“‚</div>
        <p>M3U íŒŒì¼ì„ ì—¬ê¸°ì— ë“œë˜ê·¸í•˜ê±°ë‚˜ í´ë¦­í•´ì„œ ì„ íƒ</p>
        <span>.m3u / .m3u8 íŒŒì¼ ì§€ì›</span>
      </div>
      <input type="file" id="m3u-file-input" accept=".m3u,.m3u8" style="display:none" onchange="handleM3UFile(this.files[0])">
      <div id="m3u-parse-result" style="display:none">
        <div style="font-size:13px;margin-bottom:10px">
          <span id="m3u-count" style="color:var(--live);font-weight:700"></span>
          ê°œ ì±„ë„ ë°œê²¬ â€” ì¹´í…Œê³ ë¦¬ ì„ íƒ í›„ ì¶”ê°€í•˜ì„¸ìš”
        </div>
        <div class="form-group">
          <label>ì¹´í…Œê³ ë¦¬ (ì„ íƒ)</label>
          <input type="text" id="m3u-category" placeholder="ì˜ˆ: IPTV, í•´ì™¸ë‰´ìŠ¤...">
        </div>
        <div id="m3u-preview" style="max-height:200px;overflow-y:auto;background:var(--surface2);border-radius:8px;padding:8px;margin-bottom:12px"></div>
        <button class="btn btn-primary" style="width:100%" onclick="importM3UChannels()">ëª¨ë‘ ì¶”ê°€í•˜ê¸°</button>
      </div>
    </div>

    <!-- ì¼ë°˜ ì±„ë„ ì¶”ê°€ -->
    <div id="normal-add-section">
      <div class="form-group">
        <label>ì±„ë„ ì´ë¦„</label>
        <input type="text" id="ch-name" placeholder="ì˜ˆ: YTN ë‰´ìŠ¤">
      </div>
      <div class="form-group">
        <label id="url-label">YouTube URL</label>
        <input type="text" id="ch-url" placeholder="https://www.youtube.com/watch?v=...">
      </div>
      <div class="form-group">
        <label>ì¹´í…Œê³ ë¦¬ (ì„ íƒ)</label>
        <input type="text" id="ch-category" placeholder="ì˜ˆ: ë‰´ìŠ¤, ìŠ¤í¬ì¸ , ì˜í™”...">
        <div id="cat-suggestions" style="display:flex;gap:4px;flex-wrap:wrap;margin-top:6px"></div>
      </div>
      <div id="type-hint" style="font-size:12px;color:var(--text2);line-height:1.7;background:var(--surface2);padding:9px 12px;border-radius:7px;margin-bottom:4px">
        YouTube embedê°€ í—ˆìš©ëœ URLì„ ì‚¬ìš©í•˜ì„¸ìš”.
      </div>
      <div class="modal-actions">
        <button class="btn btn-ghost" onclick="closeModal('add-modal')">ì·¨ì†Œ</button>
        <button class="btn btn-primary" onclick="addChannel()">ì¶”ê°€í•˜ê¸°</button>
      </div>
    </div>
  </div>
</div>

<!-- ====== ê³µê°œ ì†ŒìŠ¤ ëª¨ë‹¬ ====== -->
<div class="modal-overlay" id="search-modal">
  <div class="modal" style="width:560px">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px">
      <div class="modal-title" style="margin-bottom:0">ğŸŒ ê³µê°œ ìŠ¤íŠ¸ë¦¬ë° ì†ŒìŠ¤</div>
      <button style="background:none;border:none;color:var(--text2);font-size:20px;cursor:pointer" onclick="closeModal('search-modal')">âœ•</button>
    </div>
    <div id="source-list" style="display:flex;flex-direction:column;gap:8px;max-height:460px;overflow-y:auto"></div>
    <div class="modal-actions">
      <button class="btn btn-ghost" onclick="closeModal('search-modal')">ë‹«ê¸°</button>
    </div>
  </div>
</div>

<!-- ====== ë©€í‹°ë·° ëª¨ë‹¬ ====== -->
<div class="modal-overlay" id="mv-modal">
  <div class="modal" style="width:560px">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px">
      <div class="modal-title" style="margin-bottom:0">âŠ ë©€í‹°ë·° ì„¤ì •</div>
      <button style="background:none;border:none;color:var(--text2);font-size:20px;cursor:pointer" onclick="closeModal('mv-modal')">âœ•</button>
    </div>
    <div style="font-size:13px;color:var(--text2);margin-bottom:16px">í™”ë©´ ë¶„í•  ìˆ˜ë¥¼ ì„ íƒí•˜ê³ , ê° ì¹¸ì— ì±„ë„ì„ ë°°ì¹˜í•˜ì„¸ìš”.</div>
    <div class="mv-controls" style="margin-bottom:16px">
      <button class="mv-btn" onclick="setMVLayout(1)">â–  1í™”ë©´</button>
      <button class="mv-btn active" onclick="setMVLayout(2)">âŠŸ 2ë¶„í• </button>
      <button class="mv-btn" onclick="setMVLayout(4)">âŠ 4ë¶„í• </button>
    </div>
    <div id="mv-slot-list" style="display:flex;flex-direction:column;gap:8px;max-height:300px;overflow-y:auto"></div>
    <div class="modal-actions">
      <button class="btn btn-ghost" onclick="closeModal('mv-modal');stopMultiview()">ë©€í‹°ë·° ì¢…ë£Œ</button>
      <button class="btn btn-primary" onclick="applyMultiview()">ì ìš©</button>
    </div>
  </div>
</div>

<script>
// ========== STATE ==========
let channels = JSON.parse(localStorage.getItem('mystream_v2_channels') || '[]');
let favorites = JSON.parse(localStorage.getItem('mystream_v2_favs') || '[]');
let recentIds = JSON.parse(localStorage.getItem('mystream_v2_recent') || '[]');
let currentType = 'youtube';
let activeId = null;
let currentCh = null;
let activeCat = 'all';
let currentHls = null;

// ë©€í‹°ë·° ìƒíƒœ
let mvMode = false;
let mvLayout = 2;
let mvSlots = []; // [{ch, el}]
let pendingMvSlots = [null, null]; // ì„¤ì • ì¤‘ ìŠ¬ë¡¯

// ========== PUBLIC SOURCES ==========
const publicSources = [
  { name:'Big Buck Bunny', url:'https://test-streams.mux.dev/x36xhzz/x36xhzz.m3u8', desc:'Mux ê³µê°œ HLS í…ŒìŠ¤íŠ¸', type:'m3u', badge:'ğŸ°', cat:'í…ŒìŠ¤íŠ¸' },
  { name:'Apple HLS Sample', url:'https://devstreaming-cdn.apple.com/videos/streaming/examples/img_bipbop_adv_example_fmp4/master.m3u8', desc:'Apple ê³µì‹ HLS ìƒ˜í”Œ', type:'m3u', badge:'ğŸ', cat:'í…ŒìŠ¤íŠ¸' },
  { name:'NASA TV', url:'https://ntv1.akamaized.net/hls/live/2014075/NASA-NTV1-HLS/master.m3u8', desc:'NASA TV ê³µì‹ HLS ë¼ì´ë¸Œ', type:'m3u', badge:'ğŸš€', cat:'ë‰´ìŠ¤' },
  { name:'Al Jazeera English', url:'https://live-hls-web-aje.getaj.net/AJE/01.m3u8', desc:'Al Jazeera HLS ë¼ì´ë¸Œ', type:'m3u', badge:'ğŸŒ', cat:'ë‰´ìŠ¤' },
  { name:'DW News', url:'https://dwamdstream102.akamaized.net/hls/live/2015525/dwstream102/index.m3u8', desc:'Deutsche Welle HLS', type:'m3u', badge:'ğŸ‡©ğŸ‡ª', cat:'ë‰´ìŠ¤' },
  { name:'France 24 English', url:'https://live.france24.com/hls/live/2037844/F24_EN_HI_HLS/master.m3u8', desc:'France 24 HLS', type:'m3u', badge:'ğŸ‡«ğŸ‡·', cat:'ë‰´ìŠ¤' },
  { name:'Euronews', url:'https://euronews-euronews-ww-en-egress.rakuten.nv.akamaized.net/hls/live/2058930/euronewswwen/index.m3u8', desc:'Euronews HLS', type:'m3u', badge:'ğŸ‡ªğŸ‡º', cat:'ë‰´ìŠ¤' },
  { name:'Akamai Live Test', url:'https://cph-p2p-msl.akamaized.net/hls/live/2000341/test/master.m3u8', desc:'Akamai ê³µê°œ í…ŒìŠ¤íŠ¸', type:'m3u', badge:'ğŸ“¡', cat:'í…ŒìŠ¤íŠ¸' },
  { name:'Tears of Steel', url:'https://demo.unified-streaming.com/k8s/features/stable/video/tears-of-steel/tears-of-steel.ism/.m3u8', desc:'Unified Streaming ë°ëª¨', type:'m3u', badge:'ğŸ¬', cat:'í…ŒìŠ¤íŠ¸' },
];

const youtubeSources = [
  { name:'NASA TV Live', url:'https://www.youtube.com/watch?v=21X5lGlDOfg', badge:'ğŸš€', cat:'ê³¼í•™' },
  { name:'Al Jazeera English', url:'https://www.youtube.com/watch?v=F-PDSKy4R0I', badge:'ğŸŒ', cat:'ë‰´ìŠ¤' },
  { name:'DW News', url:'https://www.youtube.com/watch?v=zCkiqVbxN20', badge:'ğŸ‡©ğŸ‡ª', cat:'ë‰´ìŠ¤' },
  { name:'NHK World', url:'https://www.youtube.com/watch?v=coYw-eVU0Ks', badge:'ğŸ‡¯ğŸ‡µ', cat:'ë‰´ìŠ¤' },
  { name:'Euronews', url:'https://www.youtube.com/watch?v=KovINkxHzYE', badge:'ğŸ‡ªğŸ‡º', cat:'ë‰´ìŠ¤' },
  { name:'France 24', url:'https://www.youtube.com/watch?v=h3MuIUNCCzI', badge:'ğŸ‡«ğŸ‡·', cat:'ë‰´ìŠ¤' },
  { name:'Bloomberg TV', url:'https://www.youtube.com/watch?v=dp8PhLsUcFE', badge:'ğŸ’¹', cat:'ê²½ì œ' },
  { name:'ABC News Australia', url:'https://www.youtube.com/watch?v=vOTiJkg1voo', badge:'ğŸ¦˜', cat:'ë‰´ìŠ¤' },
];

// ========== MODAL ==========
function openModal(id) { document.getElementById(id).classList.add('open'); }
function closeModal(id) { document.getElementById(id).classList.remove('open'); }
document.querySelectorAll('.modal-overlay').forEach(el => {
  el.addEventListener('click', e => { if(e.target===el) el.classList.remove('open'); });
});

// ========== SIDEBAR TABS ==========
function switchSideTab(tab) {
  document.querySelectorAll('.sidebar-tab').forEach((t,i) => {
    t.classList.toggle('active', ['my','fav','pub'][i]===tab);
  });
  document.querySelectorAll('.sidebar-panel').forEach(p => p.classList.remove('active'));
  document.getElementById('panel-'+tab).classList.add('active');
}

// ========== CATEGORY ==========
function setCat(cat, el) {
  activeCat = cat;
  document.querySelectorAll('.cat-chip').forEach(c => c.classList.remove('active'));
  el.classList.add('active');
  renderSidebar();
  renderGrid();
}

function getAllCats() {
  const cats = new Set();
  channels.forEach(ch => { if(ch.cat) cats.add(ch.cat); });
  return [...cats];
}

function renderCatFilter() {
  const cats = getAllCats();
  const el = document.getElementById('cat-filter');
  el.innerHTML = `<div class="cat-chip ${activeCat==='all'?'active':''}" data-cat="all" onclick="setCat('all',this)">ì „ì²´</div>`;
  cats.forEach(cat => {
    el.innerHTML += `<div class="cat-chip ${activeCat===cat?'active':''}" onclick="setCat('${cat}',this)">${cat}</div>`;
  });
  // ì¹´í…Œê³ ë¦¬ ì¶”ì²œ (ì±„ë„ ì¶”ê°€ ëª¨ë‹¬)
  const sugg = document.getElementById('cat-suggestions');
  if(sugg) sugg.innerHTML = cats.map(c => `<span onclick="document.getElementById('ch-category').value='${c}'" style="padding:3px 8px;background:var(--surface2);border:1px solid var(--border);border-radius:10px;font-size:10px;cursor:pointer;color:var(--text2)">${c}</span>`).join('');
}

// ========== TYPE TABS ==========
const typeHints = {
  youtube:'YouTube embed í—ˆìš© URLì„ ì…ë ¥í•˜ì„¸ìš”. ì¼ë¶€ ì±„ë„ì€ í¼ê°€ê¸° ê¸ˆì§€ë¡œ ì¬ìƒì´ ì•ˆ ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.',
  m3u:'M3U8/HLS URLì„ ì§ì ‘ ì…ë ¥í•˜ì„¸ìš”. CORSê°€ í—ˆìš©ëœ ìŠ¤íŠ¸ë¦¼ë§Œ ì¬ìƒë©ë‹ˆë‹¤.',
  custom:'iframe ì„ë² ë“œ ê°€ëŠ¥í•œ URLì„ ì…ë ¥í•˜ì„¸ìš”.',
  'm3u-file':'M3U í”Œë ˆì´ë¦¬ìŠ¤íŠ¸ íŒŒì¼(.m3u/.m3u8)ì„ ë¶ˆëŸ¬ì™€ ì±„ë„ì„ ì¼ê´„ ì¶”ê°€í•©ë‹ˆë‹¤.'
};

function setType(type, btn) {
  currentType = type;
  document.querySelectorAll('.type-tab').forEach(t => t.classList.remove('active','youtube','m3u','custom'));
  btn.classList.add('active', type === 'm3u-file' ? 'm3u' : type);
  document.getElementById('type-hint') && (document.getElementById('type-hint').textContent = typeHints[type]);
  const isMV = type === 'm3u-file';
  document.getElementById('m3u-file-section').style.display = isMV ? 'block' : 'none';
  document.getElementById('normal-add-section').style.display = isMV ? 'none' : 'block';
  if(!isMV) {
    const labels = { youtube:'YouTube URL', m3u:'M3U/HLS URL', custom:'ìŠ¤íŠ¸ë¦¼ URL' };
    document.getElementById('url-label').textContent = labels[type];
  }
}

// ========== M3U FILE PARSER ==========
let parsedM3UChannels = [];

function handleM3UFile(file) {
  if(!file) return;
  const reader = new FileReader();
  reader.onload = e => {
    parsedM3UChannels = parseM3U(e.target.result);
    const countEl = document.getElementById('m3u-count');
    countEl.textContent = parsedM3UChannels.length;
    const preview = document.getElementById('m3u-preview');
    preview.innerHTML = parsedM3UChannels.slice(0,20).map(ch =>
      `<div style="display:flex;align-items:center;gap:8px;padding:4px 0;border-bottom:1px solid var(--border)">
        <span style="font-size:11px;color:var(--m3u)">ğŸ“¡</span>
        <span style="font-size:12px;flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${ch.name}</span>
        <span style="font-size:10px;color:var(--text2)">${ch.group||''}</span>
      </div>`
    ).join('') + (parsedM3UChannels.length>20?`<div style="font-size:11px;color:var(--text2);padding:6px 0;text-align:center">...ì™¸ ${parsedM3UChannels.length-20}ê°œ</div>`:'');
    document.getElementById('m3u-parse-result').style.display = 'block';
    showToast(`âœ… ${parsedM3UChannels.length}ê°œ ì±„ë„ì„ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤`, 'success');
  };
  reader.readAsText(file);
}

function parseM3U(text) {
  const lines = text.split('\n').map(l=>l.trim()).filter(Boolean);
  const result = [];
  let current = null;
  for(const line of lines) {
    if(line.startsWith('#EXTINF')) {
      const name = line.match(/,(.+)$/)?.[1]?.trim() || 'ì•Œ ìˆ˜ ì—†ìŒ';
      const group = line.match(/group-title="([^"]+)"/)?.[1] || '';
      const logo = line.match(/tvg-logo="([^"]+)"/)?.[1] || '';
      current = { name, group, logo, type:'m3u' };
    } else if(line && !line.startsWith('#') && current) {
      current.url = line;
      result.push(current);
      current = null;
    }
  }
  return result;
}

function importM3UChannels() {
  const cat = document.getElementById('m3u-category').value.trim();
  let added = 0;
  parsedM3UChannels.forEach(ch => {
    if(channels.find(c=>c.url===ch.url)) return;
    channels.push({
      id: Date.now() + Math.random(),
      name: ch.name,
      url: ch.url,
      type: 'm3u',
      cat: cat || ch.group || '',
      added: new Date().toLocaleDateString('ko-KR')
    });
    added++;
  });
  save();
  renderAll();
  closeModal('add-modal');
  showToast(`âœ… ${added}ê°œ ì±„ë„ ì¶”ê°€ ì™„ë£Œ`, 'success');
}

// M3U ë“œë˜ê·¸ì•¤ë“œë¡­
const dz = document.getElementById('drop-zone');
dz.addEventListener('dragover', e => { e.preventDefault(); dz.classList.add('drag-over'); });
dz.addEventListener('dragleave', () => dz.classList.remove('drag-over'));
dz.addEventListener('drop', e => { e.preventDefault(); dz.classList.remove('drag-over'); handleM3UFile(e.dataTransfer.files[0]); });

// ========== ADD / REMOVE CHANNEL ==========
function addChannel() {
  const name = document.getElementById('ch-name').value.trim();
  const url = document.getElementById('ch-url').value.trim();
  const cat = document.getElementById('ch-category').value.trim();
  if(!name || !url) { showToast('âŒ ì±„ë„ ì´ë¦„ê³¼ URLì„ ì…ë ¥í•´ì£¼ì„¸ìš”', 'error'); return; }
  if(channels.find(c=>c.url===url)) { showToast('ì´ë¯¸ ì¶”ê°€ëœ ì±„ë„ì…ë‹ˆë‹¤', 'error'); return; }
  channels.push({ id:Date.now(), name, url, type:currentType, cat, added:new Date().toLocaleDateString('ko-KR') });
  save(); renderAll(); closeModal('add-modal');
  document.getElementById('ch-name').value = '';
  document.getElementById('ch-url').value = '';
  document.getElementById('ch-category').value = '';
  showToast(`âœ… "${name}" ì¶”ê°€ë¨`, 'success');
}

function removeChannel(id, e) {
  if(e && e.stopPropagation) e.stopPropagation();
  channels = channels.filter(c=>c.id!==id);
  favorites = favorites.filter(f=>f!==id);
  recentIds = recentIds.filter(r=>r!==id);
  if(activeId===id) { activeId=null; currentCh=null; stopPlayer(); }
  save(); renderAll();
  showToast('ì±„ë„ ì‚­ì œë¨');
}

// ========== FAVORITES ==========
function toggleFav(id) {
  if(favorites.includes(id)) favorites = favorites.filter(f=>f!==id);
  else favorites.push(id);
  save(); renderAll(); updateFavBtn();
}

function toggleFavCurrent() {
  if(!activeId) return;
  toggleFav(activeId);
}

function updateFavBtn() {
  const btn = document.getElementById('fav-toggle-btn');
  if(!btn || !activeId) return;
  const isFav = favorites.includes(activeId);
  btn.textContent = isFav ? 'â˜… ì¦ê²¨ì°¾ê¸° í•´ì œ' : 'â˜† ì¦ê²¨ì°¾ê¸°';
  btn.style.color = isFav ? 'var(--fav)' : '';
  btn.style.borderColor = isFav ? 'rgba(245,158,11,0.4)' : '';
}

// ========== RECENT ==========
function addRecent(id) {
  recentIds = [id, ...recentIds.filter(r=>r!==id)].slice(0,8);
  localStorage.setItem('mystream_v2_recent', JSON.stringify(recentIds));
}

function renderRecent() {
  const validRecent = recentIds.map(id=>channels.find(c=>c.id===id)).filter(Boolean);
  const strip = document.getElementById('recent-strip');
  const list = document.getElementById('recent-list');
  if(validRecent.length===0) { strip.style.display='none'; return; }
  strip.style.display='block';
  list.innerHTML = validRecent.map(ch => {
    const icon = ch.type==='youtube'?'â–¶':ch.type==='m3u'?'ğŸ“¡':'ğŸ”—';
    return `<div class="recent-chip" onclick='playChannel(${JSON.stringify(ch)})'>${icon} ${ch.name}</div>`;
  }).join('');
}

// ========== SAVE ==========
function save() {
  localStorage.setItem('mystream_v2_channels', JSON.stringify(channels));
  localStorage.setItem('mystream_v2_favs', JSON.stringify(favorites));
}

// ========== PLAY ==========
function resetPlayer() {
  if(currentHls) { try{currentHls.destroy();}catch(e){} currentHls=null; }
  const video = document.getElementById('hls-player');
  video.pause(); video.removeAttribute('src'); video.load();
  document.getElementById('hls-player').style.display='none';
  document.getElementById('yt-placeholder').style.display='none';
  document.getElementById('custom-player').src='';
  document.getElementById('custom-player').style.display='none';
  document.getElementById('player-placeholder').style.display='none';
}

function stopPlayer() {
  resetPlayer();
  document.getElementById('player-placeholder').style.display='flex';
  document.getElementById('player-info').style.display='none';
  document.getElementById('epg-strip').style.display='none';
}

function playChannel(ch) {
  // ë©€í‹°ë·° ëª¨ë“œë©´ ìŠ¬ë¡¯ì— ì¶”ê°€
  if(mvMode) { addToMvSlot(ch); return; }

  activeId = ch.id;
  currentCh = ch;
  resetPlayer();

  if(ch.type==='youtube') {
    const videoId = extractYoutubeId(ch.url);
    if(!videoId) { showPlayerError(ch,'ìœ íš¨í•œ YouTube URLì´ ì•„ë‹™ë‹ˆë‹¤.'); return; }
    playYoutube(ch, videoId);
  } else if(ch.type==='m3u') {
    playHLS(ch);
  } else {
    const iframe = document.getElementById('custom-player');
    iframe.src = ch.url;
    iframe.style.display = 'block';
  }

  document.getElementById('player-info').style.display='flex';
  document.getElementById('player-title').textContent = ch.name;
  document.getElementById('player-meta').textContent = ch.cat ? `${ch.cat} Â· ${ch.type.toUpperCase()}` : ch.type.toUpperCase();
  const badge = document.getElementById('player-badge');
  badge.textContent = {youtube:'YouTube',m3u:'HLS',custom:'Custom'}[ch.type]||ch.type;
  badge.className = 'type-badge '+ch.type;

  if(ch.id && ch.id !== '__preview__') addRecent(ch.id);
  updateFavBtn();
  renderSidebar(); renderGrid(); renderRecent();
  showEPG();
}

function playYoutube(ch, videoId) {
  const ytEl = document.getElementById('yt-placeholder');
  ytEl.style.display='block';
  const pageOrigin = location.origin !== 'null' ? location.origin : 'https://mystream.local';
  const embedUrl = `https://www.youtube-nocookie.com/embed/${videoId}?autoplay=1&rel=0&enablejsapi=1&origin=${encodeURIComponent(pageOrigin)}`;
  ytEl.innerHTML = `
    <iframe
      src="${embedUrl}"
      style="width:100%;height:100%;border:none;display:block"
      title="YouTube video player"
      allowfullscreen
      allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
      referrerpolicy="strict-origin-when-cross-origin">
    </iframe>`;
}

function playHLS(ch) {
  const video = document.getElementById('hls-player');
  video.style.display = 'block';
  if(Hls.isSupported()) {
    currentHls = new Hls({ enableWorker:true, lowLatencyMode:true });
    currentHls.loadSource(ch.url);
    currentHls.attachMedia(video);
    currentHls.on(Hls.Events.MANIFEST_PARSED, ()=>{ video.play().catch(()=>{}); });
    currentHls.on(Hls.Events.ERROR, (event,data) => {
      if(data.fatal) { video.style.display='none'; showPlayerError(ch,'ìŠ¤íŠ¸ë¦¼ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. CORS ì •ì±…ìœ¼ë¡œ ì°¨ë‹¨ëì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.'); }
    });
  } else if(video.canPlayType('application/vnd.apple.mpegurl')) {
    video.src = ch.url; video.play().catch(()=>{});
  } else {
    showPlayerError(ch,'ì´ ë¸Œë¼ìš°ì €ì—ì„œëŠ” HLS ì¬ìƒì´ ì§€ì›ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
  }
}

function showPlayerError(ch, msg) {
  const ytEl = document.getElementById('yt-placeholder');
  ytEl.style.display='block';
  ytEl.innerHTML = `
    <div style="display:flex;flex-direction:column;align-items:center;justify-content:center;height:100%;gap:14px;background:#0d0d0d;padding:24px;text-align:center">
      <div style="font-size:36px">âš ï¸</div>
      <div>
        <div style="font-size:15px;font-weight:700;margin-bottom:6px;color:var(--accent)">${ch.name}</div>
        <div style="font-size:12px;color:var(--text2);max-width:340px;line-height:1.7">${msg}</div>
        <a href="${ch.url}" target="_blank" style="display:inline-block;margin-top:14px;padding:8px 16px;background:var(--surface2);border:1px solid var(--border);color:var(--text);border-radius:7px;text-decoration:none;font-size:12px">ğŸ”— ì§ì ‘ ì—´ê¸°</a>
      </div>
    </div>`;
}

// ========== MULTIVIEW ==========
function setMVLayout(n) {
  mvLayout = n;
  pendingMvSlots = Array(n).fill(null);
  document.querySelectorAll('.mv-btn').forEach((b,i)=>b.classList.toggle('active',[1,2,4][i]===n));
  renderMvSlotList();
}

function renderMvSlotList() {
  const el = document.getElementById('mv-slot-list');
  el.innerHTML = pendingMvSlots.map((ch,i) => `
    <div style="display:flex;align-items:center;gap:10px;padding:10px;background:var(--surface2);border-radius:8px;border:1px solid ${ch?'var(--accent)':'var(--border)'}">
      <div style="font-size:20px;width:36px;text-align:center">${ch ? (ch.type==='youtube'?'â–¶':'ğŸ“¡') : 'â¬œ'}</div>
      <div style="flex:1;font-size:12px">${ch ? ch.name : '<span style="color:var(--text2)">ë¹„ì–´ìˆìŒ</span>'}</div>
      ${ch ? `<button onclick="pendingMvSlots[${i}]=null;renderMvSlotList()" style="background:none;border:none;color:var(--text2);cursor:pointer;font-size:14px">âœ•</button>` : ''}
      <select onchange="assignMvSlot(${i},this.value)" style="font-size:11px;padding:4px 8px;max-width:140px">
        <option value="">ì±„ë„ ì„ íƒ...</option>
        ${channels.map(c=>`<option value="${c.id}" ${ch&&ch.id===c.id?'selected':''}>${c.name}</option>`).join('')}
      </select>
    </div>`
  ).join('');
}

function assignMvSlot(idx, id) {
  const ch = channels.find(c=>String(c.id)===String(id));
  pendingMvSlots[idx] = ch || null;
  renderMvSlotList();
}

function addToMultiview() {
  if(!currentCh) return;
  openModal('mv-modal');
  // ë¹ˆ ìŠ¬ë¡¯ì— í˜„ì¬ ì±„ë„ ìë™ ë°°ì¹˜
  const emptyIdx = pendingMvSlots.findIndex(s=>!s);
  if(emptyIdx>=0) { pendingMvSlots[emptyIdx]=currentCh; renderMvSlotList(); }
}

function addToMvSlot(ch) {
  // ë©€í‹°ë·° í™œì„± ìƒíƒœì—ì„œ ì±„ë„ í´ë¦­ ì‹œ ë¹ˆ ìŠ¬ë¡¯ì— ì¶”ê°€
  const emptyIdx = mvSlots.findIndex(s=>!s.ch);
  if(emptyIdx>=0) {
    mvSlots[emptyIdx].ch = ch;
    loadMvCell(emptyIdx, ch);
  } else {
    showToast('ëª¨ë“  ìŠ¬ë¡¯ì´ ì°¨ ìˆìŠµë‹ˆë‹¤');
  }
}

function applyMultiview() {
  const filled = pendingMvSlots.filter(Boolean);
  if(filled.length===0) { showToast('âŒ ì±„ë„ì„ ìµœì†Œ 1ê°œ ì„ íƒí•´ì£¼ì„¸ìš”','error'); return; }

  mvMode = true;
  document.getElementById('player-wrapper').style.display='none';
  const mvEl = document.getElementById('multiview-wrapper');
  mvEl.classList.add('active');
  mvEl.className = `multiview-wrapper active ${mvLayout===4?'mv-4':'mv-2'}`;
  if(mvLayout===1) { mvEl.style.gridTemplateColumns='1fr'; mvEl.style.gridTemplateRows='1fr'; }

  mvEl.innerHTML = '';
  mvSlots = [];

  for(let i=0;i<mvLayout;i++) {
    const cell = document.createElement('div');
    cell.className = 'mv-cell';
    cell.dataset.idx = i;
    const ch = pendingMvSlots[i];
    if(ch) {
      cell.innerHTML = `<div class="mv-cell-label"><span>${ch.name}</span><button onclick="clearMvCell(${i})" style="background:none;border:none;color:white;cursor:pointer;font-size:11px">âœ•</button></div>`;
      loadMvCell(i, ch, cell);
    } else {
      cell.innerHTML = `<div class="mv-cell-empty"><span>â¬œ</span><span style="font-size:10px">í´ë¦­í•´ì„œ ì±„ë„ ì¶”ê°€</span></div>`;
      cell.onclick = ()=>{ openModal('add-modal'); };
    }
    mvEl.appendChild(cell);
    mvSlots.push({ ch, el:cell });
  }

  closeModal('mv-modal');
  document.getElementById('player-info').style.display='none';
}

function loadMvCell(idx, ch, cellEl) {
  const cell = cellEl || mvSlots[idx]?.el;
  if(!cell) return;
  let mediaHtml = '';
  if(ch.type==='youtube') {
    const videoId = extractYoutubeId(ch.url);
    if(videoId) {
      const pageOrigin = location.origin !== 'null' ? location.origin : 'https://mystream.local';
      mediaHtml = `<iframe src="https://www.youtube-nocookie.com/embed/${videoId}?autoplay=1&mute=1&rel=0&origin=${encodeURIComponent(pageOrigin)}" style="width:100%;height:100%;border:none" allowfullscreen allow="autoplay; encrypted-media" referrerpolicy="strict-origin-when-cross-origin"></iframe>`;
    }
  } else if(ch.type==='m3u') {
    mediaHtml = `<video id="mv-video-${idx}" style="width:100%;height:100%;object-fit:contain" muted playsinline controls></video>`;
  } else {
    mediaHtml = `<iframe src="${ch.url}" style="width:100%;height:100%;border:none" allowfullscreen allow="autoplay; encrypted-media"></iframe>`;
  }
  cell.innerHTML = mediaHtml + `<div class="mv-cell-label"><span>${ch.name}</span><button onclick="clearMvCell(${idx})" style="background:none;border:none;color:white;cursor:pointer;font-size:11px">âœ•</button></div>`;

  // HLS ì—°ê²°
  if(ch.type==='m3u') {
    const v = document.getElementById(`mv-video-${idx}`);
    if(v && Hls.isSupported()) {
      const hls = new Hls({lowLatencyMode:true});
      hls.loadSource(ch.url); hls.attachMedia(v);
      hls.on(Hls.Events.MANIFEST_PARSED,()=>v.play().catch(()=>{}));
    }
  }
}

function clearMvCell(idx) {
  if(!mvSlots[idx]) return;
  mvSlots[idx].ch = null;
  mvSlots[idx].el.innerHTML = `<div class="mv-cell-empty"><span>â¬œ</span><span style="font-size:10px">ë¹„ì–´ìˆìŒ</span></div>`;
}

function stopMultiview() {
  mvMode = false;
  const mvEl = document.getElementById('multiview-wrapper');
  mvEl.classList.remove('active');
  mvEl.innerHTML = '';
  mvSlots = [];
  document.getElementById('player-wrapper').style.display='block';
  document.getElementById('player-placeholder').style.display='flex';
  activeId = null; currentCh = null;
  renderSidebar(); renderGrid();
}

// ========== YOUTUBE ==========
function extractYoutubeId(url) {
  if(!url) return null;
  const patterns = [
    /(?:youtube\.com\/watch\?v=|youtu\.be\/|youtube\.com\/embed\/|youtube\.com\/live\/|youtube\.com\/shorts\/)([A-Za-z0-9_-]{11})/,
    /[?&]v=([A-Za-z0-9_-]{11})/,
    /^([A-Za-z0-9_-]{11})$/
  ];
  for(const p of patterns) { const m=url.match(p); if(m) return m[1]; }
  return null;
}

// ========== EPG (Mock) ==========
function showEPG() {
  const strip = document.getElementById('epg-strip');
  const now = new Date();
  const items = [];
  const shows = ['ë‰´ìŠ¤','ìŠ¤í¬ì¸ ','ì˜í™”','ë‹¤í','í† í¬ì‡¼','ìŒì•…','ë“œë¼ë§ˆ','ì˜ˆëŠ¥'];
  for(let i=-1;i<4;i++) {
    const t = new Date(now.getTime()+i*3600000);
    const h = t.getHours().toString().padStart(2,'0');
    const m = Math.round(t.getMinutes()/30)*30;
    const show = shows[Math.floor(Math.random()*shows.length)];
    items.push(`<div class="epg-item ${i===0?'now':''}"><div class="epg-time">${h}:${m===0?'00':'30'}</div><div class="epg-show">${show}</div></div>`);
  }
  strip.innerHTML = '<div style="font-size:10px;color:var(--text2);white-space:nowrap;font-weight:700;flex-shrink:0">ğŸ“… í¸ì„± (ìƒ˜í”Œ)</div>'+items.join('');
  strip.style.display='flex';
}

// ========== RENDER ==========
function renderAll() {
  renderCatFilter();
  renderSidebar();
  renderGrid();
  renderFavs();
  renderPublicSources();
  renderSourceList();
  renderRecent();
  const hint = document.getElementById('hint-box');
  hint.style.display = channels.length>0 ? 'none' : 'block';
}

function renderSidebar() {
  const el = document.getElementById('sidebar-channels');
  let list = channels;
  if(activeCat!=='all') list = channels.filter(ch=>ch.cat===activeCat);
  if(list.length===0) { el.innerHTML='<div style="padding:12px 8px;font-size:12px;color:var(--text2)">ì±„ë„ì´ ì—†ìŠµë‹ˆë‹¤</div>'; return; }
  el.innerHTML = list.map(ch => {
    const isFav = favorites.includes(ch.id);
    const icon = ch.type==='youtube'?'â–¶':ch.type==='m3u'?'ğŸ“¡':'ğŸ”—';
    return `
    <div class="channel-item ${activeId===ch.id?'active':''}" onclick='playChannel(${safeJSON(ch)})'>
      <div class="ch-icon ${ch.type}">${icon}</div>
      <div class="ch-info">
        <div class="ch-name">${ch.name}</div>
        <div class="ch-meta">
          ${isFav?'<span style="color:var(--fav)">â˜…</span>':''}
          <span>${ch.cat||ch.type.toUpperCase()}</span>
        </div>
      </div>
      <div class="ch-actions">
        <button class="ch-btn ${isFav?'fav-on':''}" onclick="event.stopPropagation();toggleFav(${ch.id})">${isFav?'â˜…':'â˜†'}</button>
        <button class="ch-btn" onclick="removeChannel(${ch.id},event)">ğŸ—‘</button>
      </div>
    </div>`;
  }).join('');
}

function renderFavs() {
  const el = document.getElementById('sidebar-favs');
  const favChs = favorites.map(id=>channels.find(c=>c.id===id)).filter(Boolean);
  if(favChs.length===0) { el.innerHTML='<div style="padding:16px 8px;font-size:12px;color:var(--text2);text-align:center">â­ ì¦ê²¨ì°¾ê¸°í•œ ì±„ë„ì´ ì—†ìŠµë‹ˆë‹¤<br><span style="font-size:11px;opacity:0.7">ì±„ë„ ìœ„ì— ë§ˆìš°ìŠ¤ë¥¼ ì˜¬ë¦¬ë©´<br>â˜… ë²„íŠ¼ì´ ë‚˜íƒ€ë‚©ë‹ˆë‹¤</span></div>'; return; }
  el.innerHTML = favChs.map(ch => {
    const icon = ch.type==='youtube'?'â–¶':ch.type==='m3u'?'ğŸ“¡':'ğŸ”—';
    return `
    <div class="channel-item ${activeId===ch.id?'active':''}" onclick='playChannel(${safeJSON(ch)})'>
      <div class="ch-icon ${ch.type}">${icon}</div>
      <div class="ch-info">
        <div class="ch-name">${ch.name}</div>
        <div class="ch-meta"><span style="color:var(--fav)">â˜…</span><span>${ch.cat||''}</span></div>
      </div>
      <div class="ch-actions">
        <button class="ch-btn fav-on" onclick="event.stopPropagation();toggleFav(${ch.id})">â˜…</button>
        <button class="ch-btn" onclick="removeChannel(${ch.id},event)">ğŸ—‘</button>
      </div>
    </div>`;
  }).join('');
}

function renderGrid() {
  const q = document.getElementById('channel-search').value.toLowerCase();
  let list = channels;
  if(activeCat!=='all') list = list.filter(ch=>ch.cat===activeCat);
  if(q) list = list.filter(ch=>ch.name.toLowerCase().includes(q)||ch.url.toLowerCase().includes(q));
  document.getElementById('ch-count').textContent = `${list.length}ê°œ ì±„ë„`;
  const grid = document.getElementById('channel-grid');
  if(channels.length===0) {
    grid.innerHTML='<div style="grid-column:1/-1;text-align:center;padding:40px;color:var(--text2)"><div style="font-size:40px;opacity:0.2;margin-bottom:10px">ğŸ“¡</div><p>ì±„ë„ì„ ì¶”ê°€í•´ë³´ì„¸ìš”</p></div>';
    return;
  }
  grid.innerHTML = list.map(ch => {
    const icon = ch.type==='youtube'?'â–¶':ch.type==='m3u'?'ğŸ“¡':'ğŸ”—';
    const isFav = favorites.includes(ch.id);
    return `
    <div class="channel-card ${activeId===ch.id?'playing':''}" onclick='playChannel(${safeJSON(ch)})'>
      <div class="card-thumb ${ch.type}-bg">
        ${icon}
        <div class="card-live-badge">LIVE</div>
        ${isFav?'<div class="card-fav">â˜…</div>':''}
      </div>
      <div class="card-body">
        <div class="card-name">${ch.name}</div>
        <div class="card-sub">
          ${ch.cat?`<span class="cat-tag">${ch.cat}</span>`:'<span></span>'}
          <span onclick="removeChannel(${ch.id},event)" style="cursor:pointer;color:var(--text2);font-size:14px">ğŸ—‘</span>
        </div>
      </div>
    </div>`;
  }).join('');
}

function renderPublicSources() {
  const el = document.getElementById('public-sources');
  let html = `<div class="pub-section-label">ğŸ“¡ HLS ìŠ¤íŠ¸ë¦¼</div>`;
  html += publicSources.map(s => {
    const isAdded = channels.find(c=>c.url===s.url);
    return `
    <div class="channel-item">
      <div class="ch-icon m3u" onclick='quickPlay(${safeJSON(s)})' style="cursor:pointer">${s.badge}</div>
      <div class="ch-info" onclick='quickPlay(${safeJSON(s)})' style="cursor:pointer">
        <div class="ch-name">${s.name}</div>
        <div class="ch-meta" style="color:${isAdded?'var(--live)':'var(--text2)'}">${isAdded?'âœ“ ì €ì¥ë¨':'â–¶ ì¬ìƒ'}</div>
      </div>
      <div class="ch-actions" style="display:flex">
        <button class="ch-btn" onclick='quickAdd(${safeJSON(s)})' title="ì €ì¥" style="color:var(--live)">ï¼‹</button>
      </div>
    </div>`;
  }).join('');
  html += `<div class="pub-section-label" style="margin-top:8px">â–¶ YouTube</div>`;
  html += youtubeSources.map(s => {
    const isAdded = channels.find(c=>c.url===s.url);
    return `
    <div class="channel-item">
      <div class="ch-icon youtube" onclick='quickPlay(${safeJSON({...s,type:"youtube"})})' style="cursor:pointer">${s.badge}</div>
      <div class="ch-info" onclick='quickPlay(${safeJSON({...s,type:"youtube"})})' style="cursor:pointer">
        <div class="ch-name">${s.name}</div>
        <div class="ch-meta" style="color:${isAdded?'var(--live)':'var(--youtube)'}">${isAdded?'âœ“ ì €ì¥ë¨':'â–¶ ì¬ìƒ'}</div>
      </div>
      <div class="ch-actions" style="display:flex">
        <button class="ch-btn" onclick='quickAdd(${safeJSON({...s,type:"youtube"})})' title="ì €ì¥" style="color:var(--live)">ï¼‹</button>
      </div>
    </div>`;
  }).join('');
  el.innerHTML = html;
}

function renderSourceList() {
  const el = document.getElementById('source-list');
  let html = `<div style="font-size:11px;color:var(--m3u);font-weight:700;padding:4px 0 8px;letter-spacing:1px">ğŸ“¡ HLS ì§ì ‘ ì¬ìƒ</div>`;
  html += publicSources.map(s => {
    const isAdded = channels.find(c=>c.url===s.url);
    return `
    <div style="display:flex;align-items:center;gap:12px;padding:10px;background:var(--surface2);border-radius:8px;border:1px solid ${isAdded?'rgba(34,197,94,0.3)':'var(--border)'}">
      <div style="width:34px;height:34px;border-radius:7px;display:flex;align-items:center;justify-content:center;font-size:18px;background:rgba(59,130,246,0.1);flex-shrink:0">${s.badge}</div>
      <div style="flex:1;min-width:0">
        <div style="font-size:13px;font-weight:600">${s.name}</div>
        <div style="font-size:11px;color:var(--text2)">${s.desc}</div>
      </div>
      <div style="display:flex;gap:5px;flex-shrink:0">
        <button class="btn btn-ghost btn-sm" onclick='quickPlay(${safeJSON(s)});closeModal("search-modal")'>â–¶</button>
        <button class="btn ${isAdded?'btn-ghost':'btn-primary'} btn-sm" onclick='quickAdd(${safeJSON(s)})'>${isAdded?'âœ“':'ï¼‹'}</button>
      </div>
    </div>`;
  }).join('');
  html += `<div style="font-size:11px;color:var(--youtube);font-weight:700;padding:16px 0 8px;letter-spacing:1px">â–¶ YouTube</div>`;
  html += youtubeSources.map(s => {
    const chObj = safeJSON({...s,type:'youtube'});
    const isAdded = channels.find(c=>c.url===s.url);
    return `
    <div style="display:flex;align-items:center;gap:12px;padding:10px;background:var(--surface2);border-radius:8px;border:1px solid var(--border)">
      <div style="width:34px;height:34px;border-radius:7px;display:flex;align-items:center;justify-content:center;font-size:18px;background:rgba(255,0,0,0.1);flex-shrink:0">${s.badge}</div>
      <div style="flex:1;min-width:0">
        <div style="font-size:13px;font-weight:600">${s.name}</div>
        <div style="font-size:11px;color:var(--text2)">${s.cat||''}</div>
      </div>
      <div style="display:flex;gap:5px;flex-shrink:0">
        <button class="btn btn-ghost btn-sm" style="color:var(--youtube)" onclick='quickPlay(${chObj});closeModal("search-modal")'>â–¶</button>
        <button class="btn ${isAdded?'btn-ghost':'btn-primary'} btn-sm" onclick='quickAdd(${chObj})'>${isAdded?'âœ“':'ï¼‹'}</button>
      </div>
    </div>`;
  }).join('');
  el.innerHTML = html;
}

function quickPlay(s) {
  const ch = { id:'__preview__', name:s.name, url:s.url, type:s.type };
  activeId='__preview__'; currentCh=ch;
  playChannel(ch);
}

function quickAdd(s) {
  if(channels.find(c=>c.url===s.url)) { showToast('ì´ë¯¸ ì¶”ê°€ëœ ì±„ë„ì…ë‹ˆë‹¤'); return; }
  channels.push({ id:Date.now(), name:s.name, url:s.url, type:s.type, cat:s.cat||'', added:new Date().toLocaleDateString('ko-KR') });
  save(); renderAll();
  showToast(`âœ… "${s.name}" ì €ì¥ë¨`, 'success');
}

// ========== HELPERS ==========
function safeJSON(obj) {
  return JSON.stringify(obj).replace(/'/g,"&#39;");
}

function showToast(msg, type='') {
  const t = document.createElement('div');
  t.className = `toast ${type}`;
  t.innerHTML = msg;
  document.body.appendChild(t);
  setTimeout(()=>{ t.style.opacity='0'; t.style.transition='opacity 0.4s'; setTimeout(()=>t.remove(),400); }, 2500);
}

// ========== INIT ==========
renderAll();
</script>
</body>
</html>
